name: GraphQL Model Codegen (Flutter, No Flutter Install)

on:
  workflow_dispatch:

jobs:
  codegen:
    runs-on: ubuntu-latest

    env:
      NODE_OPTIONS: --max-old-space-size=8192

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Amplify CLI
        run: npm install -g @aws-amplify/cli

      # ✅ AWS credentials (persist across steps)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      # ----------------------------
      # AppSync schema → data/lib/graphql
      # ----------------------------
      - name: Download GraphQL schema
        run: |
          mkdir -p data/lib/graphql
          aws appsync get-introspection-schema \
            --api-id opneacbjcnamhlztju3jf26j64 \
            --format SDL \
            data/lib/graphql/schema.graphql

      - name: Add scalar types
        run: |
          sed -i '1s/^/scalar AWSJSON\nscalar AWSDateTime\n\n/' data/lib/graphql/schema.graphql

      # ----------------------------
      # IMPORTANT: run from data/
      # ----------------------------
      - name: Generate Flutter models
        working-directory: data
        run: |
          npx @aws-amplify/cli codegen models \
            --model-schema lib/graphql/schema.graphql \
            --target flutter \
            --output-dir lib/models

      - name: Commit generated models
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/lib/models data/lib/graphql/schema.graphql
          git diff --cached --quiet || git commit -m "Generate Flutter models from AppSync"
          git push
